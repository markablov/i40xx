/* eslint-disable no-console */

import Emulator from 'i40xx-emu';

import { compileCodeForTest } from '#utilities/compile.js';
import { numToHWNumber, hwNumberToNum } from '#utilities/numbers.js';
import { writeValueToMainChars } from '#utilities/memory.js';

import RAM_DUMP from './data/ramWithLookupTables.json' assert { type: 'json' };

const PROLOGUE_CYCLES_COUNT = 4;

const runSingleTestMulti = (romDump, { a, b }) => {
  const system = new Emulator({ romDump, ramDump: RAM_DUMP });

  const { registers, memory } = system;
  registers.ramControl = 0b1110;
  registers.indexBanks[0][2] = 0x1;
  registers.indexBanks[0][3] = 0x0;
  registers.indexBanks[0][4] = 0x2;
  registers.indexBanks[0][5] = 0x0;

  writeValueToMainChars(numToHWNumber(a), memory, 0x1, 0x7);
  writeValueToMainChars(numToHWNumber(b), memory, 0x2, 0x7);

  while (!system.isFinished()) {
    system.instruction();
  }

  return {
    result: hwNumberToNum(memory[7].registers[0x08].main),
    elapsed: system.instructionCycles,
  };
};

/*
# INPUT:
#   rr2 - variable number in main memory for first factor
#   rr4 - variable number in main memory for second factor
# OUTPUT:
#   memMainVar[0x08] - product
 */

const runSingleTest16bit = (romDump, { a, b }) => {
  const system = new Emulator({ romDump, ramDump: RAM_DUMP });

  const hwNumberA = numToHWNumber(a);
  const hwNumberB = numToHWNumber(b);

  const { registers } = system;
  registers.ramControl = 0b1110;
  registers.indexBanks[0][0] = hwNumberA[0] || 0;
  registers.indexBanks[0][1] = hwNumberA[1] || 0;
  registers.indexBanks[0][2] = hwNumberA[2] || 0;
  registers.indexBanks[0][3] = hwNumberA[3] || 0;
  registers.indexBanks[0][10] = hwNumberB[0] || 0;
  registers.indexBanks[0][11] = hwNumberB[1] || 0;

  while (!system.isFinished()) {
    system.instruction();
  }

  return {
    result: hwNumberToNum([
      registers.indexBanks[0][8],
      registers.indexBanks[0][9],
      registers.indexBanks[0][14],
      registers.indexBanks[0][15],
    ]),
    elapsed: system.instructionCycles,
  };
};

const TESTS = [
  { a: 193, b: 20 },
  { a: 164, b: 16 },
  { a: 99, b: 5 },
  { a: 59, b: 15 },
  { a: 479, b: 8 },
  { a: 70, b: 46 },
  { a: 220, b: 2 },
  { a: 5, b: 80 },
  { a: 15, b: 37 },
  { a: 23, b: 25 },
  { a: 13, b: 104 },
  { a: 179, b: 2 },
  { a: 719, b: 2 },
  { a: 1453, b: 2 },
  { a: 65, b: 6 },
  { a: 431, b: 7 },
  { a: 404, b: 6 },
  { a: 14, b: 195 },
  { a: 37, b: 20 },
  { a: 1876, b: 1 },
  { a: 134, b: 11 },
  { a: 13, b: 233 },
  { a: 148, b: 10 },
  { a: 14, b: 25 },
  { a: 88, b: 5 },
  { a: 50, b: 21 },
  { a: 731, b: 2 },
  { a: 1056, b: 1 },
  { a: 31, b: 38 },
  { a: 1100, b: 1 },
  { a: 6, b: 103 },
  { a: 100, b: 34 },
  { a: 164, b: 1 },
  { a: 1, b: 14 },
  { a: 31, b: 69 },
  { a: 70, b: 6 },
  { a: 13, b: 151 },
  { a: 42, b: 35 },
  { a: 8, b: 127 },
  { a: 1558, b: 1 },
  { a: 104, b: 5 },
  { a: 106, b: 20 },
  { a: 115, b: 22 },
  { a: 35, b: 12 },
  { a: 331, b: 5 },
  { a: 58, b: 12 },
  { a: 52, b: 59 },
  { a: 418, b: 4 },
  { a: 480, b: 4 },
  { a: 1782, b: 1 },
  { a: 29, b: 56 },
  { a: 2, b: 232 },
  { a: 1583, b: 1 },
  { a: 910, b: 3 },
  { a: 19, b: 199 },
  { a: 132, b: 19 },
  { a: 55, b: 4 },
  { a: 331, b: 8 },
  { a: 451, b: 1 },
  { a: 91, b: 41 },
  { a: 258, b: 13 },
  { a: 225, b: 1 },
  { a: 1078, b: 1 },
  { a: 23, b: 81 },
  { a: 136, b: 26 },
  { a: 31, b: 18 },
  { a: 167, b: 19 },
  { a: 42, b: 36 },
  { a: 64, b: 56 },
  { a: 39, b: 28 },
  { a: 517, b: 4 },
  { a: 170, b: 7 },
  { a: 489, b: 4 },
  { a: 106, b: 39 },
  { a: 3, b: 52 },
  { a: 20, b: 155 },
  { a: 1, b: 122 },
  { a: 31, b: 14 },
  { a: 1863, b: 1 },
  { a: 447, b: 3 },
  { a: 190, b: 19 },
  { a: 265, b: 14 },
  { a: 824, b: 1 },
  { a: 29, b: 134 },
  { a: 116, b: 1 },
  { a: 12, b: 35 },
  { a: 145, b: 1 },
  { a: 479, b: 7 },
  { a: 106, b: 1 },
  { a: 758, b: 5 },
  { a: 92, b: 4 },
  { a: 24, b: 20 },
  { a: 47, b: 1 },
  { a: 82, b: 16 },
  { a: 2287, b: 1 },
  { a: 10, b: 85 },
  { a: 1662, b: 1 },
  { a: 271, b: 9 },
  { a: 527, b: 6 },
  { a: 19, b: 12 },
  { a: 496, b: 1 },
  { a: 75, b: 29 },
  { a: 16, b: 78 },
  { a: 3, b: 157 },
  { a: 22, b: 117 },
  { a: 102, b: 23 },
  { a: 9, b: 107 },
  { a: 924, b: 2 },
  { a: 368, b: 3 },
  { a: 4, b: 104 },
  { a: 82, b: 35 },
  { a: 410, b: 1 },
  { a: 325, b: 9 },
  { a: 38, b: 55 },
  { a: 16, b: 159 },
  { a: 11, b: 104 },
  { a: 1176, b: 1 },
  { a: 592, b: 4 },
  { a: 31, b: 12 },
  { a: 711, b: 3 },
  { a: 67, b: 57 },
  { a: 461, b: 6 },
  { a: 540, b: 1 },
  { a: 296, b: 4 },
  { a: 146, b: 21 },
  { a: 3, b: 9 },
  { a: 1133, b: 3 },
  { a: 6, b: 168 },
  { a: 2228, b: 1 },
  { a: 226, b: 18 },
  { a: 497, b: 5 },
  { a: 46, b: 23 },
  { a: 305, b: 5 },
  { a: 422, b: 3 },
  { a: 58, b: 55 },
  { a: 414, b: 1 },
  { a: 78, b: 3 },
  { a: 50, b: 30 },
  { a: 33, b: 22 },
  { a: 134, b: 20 },
  { a: 686, b: 5 },
  { a: 32, b: 82 },
  { a: 63, b: 36 },
  { a: 20, b: 68 },
  { a: 284, b: 10 },
  { a: 682, b: 3 },
  { a: 842, b: 3 },
  { a: 34, b: 125 },
  { a: 18, b: 35 },
  { a: 196, b: 8 },
  { a: 9, b: 33 },
  { a: 59, b: 50 },
  { a: 14, b: 182 },
  { a: 300, b: 3 },
  { a: 1396, b: 1 },
  { a: 4, b: 17 },
  { a: 300, b: 5 },
  { a: 266, b: 9 },
  { a: 145, b: 24 },
  { a: 158, b: 16 },
  { a: 927, b: 1 },
  { a: 154, b: 11 },
  { a: 37, b: 73 },
  { a: 232, b: 4 },
  { a: 1, b: 239 },
  { a: 366, b: 7 },
  { a: 432, b: 2 },
  { a: 20, b: 192 },
  { a: 250, b: 11 },
  { a: 164, b: 2 },
  { a: 248, b: 1 },
  { a: 448, b: 8 },
  { a: 9, b: 120 },
  { a: 79, b: 43 },
  { a: 32, b: 106 },
  { a: 71, b: 54 },
  { a: 57, b: 55 },
  { a: 13, b: 175 },
  { a: 1310, b: 2 },
  { a: 1714, b: 1 },
  { a: 78, b: 12 },
  { a: 79, b: 24 },
  { a: 11, b: 117 },
  { a: 2582, b: 1 },
  { a: 751, b: 3 },
  { a: 920, b: 2 },
  { a: 47, b: 6 },
  { a: 236, b: 3 },
  { a: 6, b: 98 },
  { a: 83, b: 45 },
  { a: 129, b: 9 },
  { a: 138, b: 3 },
  { a: 11, b: 203 },
  { a: 103, b: 36 },
  { a: 23, b: 33 },
  { a: 130, b: 3 },
  { a: 130, b: 18 },
  { a: 154, b: 5 },
  { a: 17, b: 48 },
  { a: 35, b: 93 },
  { a: 159, b: 19 },
  { a: 21, b: 51 },
  { a: 390, b: 2 },
  { a: 2, b: 153 },
  { a: 16, b: 114 },
  { a: 491, b: 5 },
  { a: 1546, b: 2 },
  { a: 1, b: 81 },
  { a: 2564, b: 1 },
  { a: 47, b: 46 },
  { a: 11, b: 214 },
  { a: 2092, b: 1 },
  { a: 8, b: 185 },
  { a: 2485, b: 1 },
  { a: 76, b: 19 },
  { a: 38, b: 78 },
  { a: 1910, b: 1 },
  { a: 824, b: 2 },
  { a: 271, b: 1 },
  { a: 1594, b: 1 },
  { a: 25, b: 113 },
  { a: 87, b: 16 },
  { a: 17, b: 138 },
  { a: 697, b: 3 },
  { a: 133, b: 5 },
  { a: 1686, b: 1 },
  { a: 121, b: 30 },
  { a: 44, b: 38 },
  { a: 223, b: 16 },
  { a: 453, b: 3 },
  { a: 351, b: 4 },
  { a: 43, b: 65 },
  { a: 56, b: 73 },
  { a: 16, b: 187 },
  { a: 1465, b: 2 },
  { a: 284, b: 6 },
  { a: 397, b: 4 },
  { a: 565, b: 6 },
  { a: 11, b: 155 },
  { a: 462, b: 5 },
  { a: 125, b: 34 },
  { a: 5, b: 226 },
  { a: 154, b: 7 },
  { a: 227, b: 1 },
  { a: 73, b: 31 },
  { a: 1433, b: 1 },
  { a: 193, b: 3 },
  { a: 1825, b: 2 },
  { a: 14, b: 53 },
  { a: 16, b: 60 },
  { a: 580, b: 7 },
  { a: 131, b: 22 },
  { a: 28, b: 4 },
  { a: 817, b: 3 },
  { a: 449, b: 1 },
  { a: 191, b: 18 },
  { a: 993, b: 2 },
  { a: 26, b: 82 },
  { a: 30, b: 42 },
  { a: 249, b: 2 },
  { a: 19, b: 106 },
  { a: 40, b: 54 },
  { a: 146, b: 26 },
  { a: 4, b: 233 },
  { a: 455, b: 2 },
  { a: 475, b: 4 },
  { a: 2, b: 77 },
  { a: 764, b: 1 },
  { a: 128, b: 2 },
  { a: 293, b: 10 },
  { a: 63, b: 42 },
  { a: 50, b: 12 },
  { a: 23, b: 86 },
  { a: 3, b: 36 },
  { a: 208, b: 17 },
  { a: 43, b: 51 },
  { a: 40, b: 17 },
  { a: 16, b: 116 },
  { a: 43, b: 10 },
  { a: 58, b: 2 },
  { a: 128, b: 8 },
  { a: 58, b: 51 },
  { a: 54, b: 45 },
  { a: 454, b: 2 },
  { a: 32, b: 93 },
  { a: 11, b: 171 },
  { a: 24, b: 59 },
  { a: 22, b: 156 },
  { a: 19, b: 25 },
  { a: 312, b: 8 },
  { a: 1259, b: 2 },
  { a: 17, b: 75 },
  { a: 415, b: 3 },
  { a: 50, b: 71 },
  { a: 83, b: 16 },
  { a: 4, b: 168 },
  { a: 123, b: 16 },
  { a: 26, b: 89 },
  { a: 14, b: 37 },
  { a: 38, b: 40 },
  { a: 12, b: 34 },
  { a: 6, b: 71 },
  { a: 2, b: 96 },
  { a: 7, b: 172 },
  { a: 214, b: 2 },
  { a: 2185, b: 1 },
  { a: 14, b: 36 },
  { a: 481, b: 2 },
  { a: 1705, b: 1 },
  { a: 269, b: 1 },
  { a: 14, b: 33 },
  { a: 651, b: 1 },
  { a: 17, b: 178 },
  { a: 736, b: 5 },
  { a: 19, b: 18 },
  { a: 13, b: 64 },
  { a: 63, b: 39 },
  { a: 2073, b: 1 },
  { a: 255, b: 8 },
  { a: 95, b: 44 },
  { a: 970, b: 3 },
  { a: 631, b: 3 },
  { a: 10, b: 28 },
  { a: 53, b: 79 },
  { a: 37, b: 37 },
  { a: 1613, b: 1 },
  { a: 67, b: 29 },
  { a: 580, b: 4 },
  { a: 392, b: 6 },
  { a: 57, b: 12 },
  { a: 79, b: 48 },
  { a: 185, b: 21 },
  { a: 26, b: 9 },
  { a: 1316, b: 2 },
  { a: 71, b: 60 },
  { a: 352, b: 8 },
  { a: 35, b: 54 },
  { a: 33, b: 27 },
  { a: 233, b: 17 },
  { a: 31, b: 63 },
  { a: 373, b: 5 },
  { a: 20, b: 83 },
  { a: 14, b: 94 },
  { a: 1547, b: 2 },
  { a: 18, b: 17 },
  { a: 54, b: 39 },
  { a: 221, b: 6 },
  { a: 13, b: 24 },
  { a: 241, b: 5 },
  { a: 6, b: 141 },
  { a: 147, b: 5 },
  { a: 13, b: 70 },
  { a: 3, b: 129 },
  { a: 12, b: 120 },
  { a: 95, b: 16 },
  { a: 281, b: 2 },
  { a: 22, b: 24 },
  { a: 189, b: 10 },
  { a: 871, b: 4 },
  { a: 96, b: 13 },
  { a: 352, b: 3 },
  { a: 8, b: 126 },
  { a: 30, b: 33 },
  { a: 16, b: 216 },
  { a: 62, b: 8 },
  { a: 30, b: 52 },
  { a: 883, b: 1 },
  { a: 740, b: 2 },
  { a: 1475, b: 1 },
  { a: 24, b: 12 },
  { a: 55, b: 22 },
  { a: 177, b: 4 },
  { a: 93, b: 3 },
  { a: 329, b: 1 },
  { a: 39, b: 31 },
  { a: 22, b: 157 },
  { a: 119, b: 33 },
  { a: 973, b: 3 },
  { a: 626, b: 4 },
  { a: 77, b: 22 },
  { a: 2595, b: 1 },
  { a: 374, b: 6 },
  { a: 294, b: 10 },
  { a: 12, b: 128 },
  { a: 500, b: 1 },
  { a: 2102, b: 1 },
  { a: 42, b: 30 },
  { a: 71, b: 21 },
  { a: 157, b: 13 },
  { a: 24, b: 46 },
  { a: 354, b: 5 },
  { a: 3, b: 180 },
  { a: 1720, b: 1 },
  { a: 75, b: 28 },
  { a: 53, b: 46 },
  { a: 17, b: 108 },
  { a: 71, b: 5 },
  { a: 11, b: 164 },
  { a: 10, b: 241 },
  { a: 12, b: 153 },
  { a: 6, b: 104 },
  { a: 197, b: 18 },
  { a: 255, b: 1 },
  { a: 1467, b: 1 },
  { a: 693, b: 4 },
  { a: 26, b: 126 },
  { a: 48, b: 55 },
  { a: 1261, b: 1 },
  { a: 83, b: 42 },
  { a: 434, b: 8 },
  { a: 847, b: 1 },
  { a: 69, b: 34 },
  { a: 10, b: 42 },
  { a: 21, b: 4 },
  { a: 664, b: 2 },
  { a: 10, b: 215 },
  { a: 52, b: 75 },
  { a: 1307, b: 2 },
  { a: 49, b: 30 },
  { a: 746, b: 1 },
  { a: 14, b: 162 },
  { a: 56, b: 53 },
  { a: 42, b: 60 },
  { a: 64, b: 5 },
  { a: 261, b: 14 },
  { a: 1538, b: 1 },
  { a: 90, b: 13 },
  { a: 195, b: 11 },
  { a: 772, b: 4 },
  { a: 16, b: 109 },
  { a: 7, b: 226 },
  { a: 810, b: 1 },
  { a: 1324, b: 1 },
  { a: 37, b: 50 },
  { a: 35, b: 127 },
  { a: 35, b: 56 },
  { a: 21, b: 72 },
  { a: 826, b: 1 },
  { a: 1072, b: 1 },
  { a: 22, b: 75 },
  { a: 13, b: 123 },
  { a: 56, b: 13 },
  { a: 11, b: 84 },
  { a: 8, b: 51 },
  { a: 6, b: 207 },
  { a: 866, b: 3 },
  { a: 13, b: 85 },
  { a: 13, b: 116 },
  { a: 8, b: 90 },
  { a: 14, b: 114 },
  { a: 9, b: 175 },
  { a: 33, b: 86 },
  { a: 362, b: 6 },
  { a: 242, b: 8 },
  { a: 492, b: 3 },
  { a: 28, b: 65 },
  { a: 342, b: 3 },
  { a: 3, b: 121 },
  { a: 820, b: 4 },
  { a: 6, b: 230 },
  { a: 38, b: 95 },
  { a: 17, b: 28 },
  { a: 23, b: 106 },
  { a: 1007, b: 3 },
  { a: 69, b: 22 },
  { a: 409, b: 2 },
  { a: 88, b: 9 },
  { a: 1852, b: 2 },
  { a: 16, b: 214 },
  { a: 157, b: 21 },
  { a: 467, b: 1 },
  { a: 2218, b: 1 },
  { a: 4, b: 175 },
  { a: 1507, b: 2 },
  { a: 38, b: 19 },
  { a: 805, b: 3 },
  { a: 2534, b: 1 },
  { a: 406, b: 2 },
  { a: 38, b: 31 },
  { a: 1121, b: 2 },
  { a: 19, b: 49 },
  { a: 417, b: 3 },
  { a: 5, b: 194 },
  { a: 1135, b: 1 },
  { a: 7, b: 23 },
  { a: 287, b: 5 },
  { a: 503, b: 8 },
  { a: 340, b: 1 },
  { a: 250, b: 9 },
  { a: 525, b: 4 },
  { a: 129, b: 16 },
  { a: 51, b: 47 },
  { a: 315, b: 10 },
  { a: 88, b: 28 },
  { a: 35, b: 107 },
  { a: 33, b: 91 },
  { a: 426, b: 4 },
  { a: 232, b: 2 },
  { a: 352, b: 10 },
  { a: 15, b: 89 },
  { a: 1991, b: 1 },
  { a: 6, b: 234 },
  { a: 2, b: 212 },
  { a: 31, b: 96 },
  { a: 809, b: 1 },
  { a: 1, b: 154 },
  { a: 339, b: 1 },
  { a: 62, b: 5 },
  { a: 22, b: 123 },
  { a: 9, b: 165 },
  { a: 2, b: 35 },
  { a: 290, b: 14 },
  { a: 62, b: 32 },
  { a: 169, b: 20 },
  { a: 14, b: 134 },
  { a: 139, b: 27 },
  { a: 35, b: 42 },
  { a: 128, b: 31 },
  { a: 163, b: 23 },
  { a: 89, b: 43 },
  { a: 80, b: 22 },
  { a: 39, b: 59 },
  { a: 10, b: 188 },
  { a: 41, b: 59 },
  { a: 70, b: 41 },
  { a: 218, b: 7 },
  { a: 19, b: 13 },
  { a: 852, b: 1 },
  { a: 40, b: 77 },
  { a: 43, b: 58 },
  { a: 1534, b: 1 },
  { a: 19, b: 42 },
  { a: 26, b: 65 },
  { a: 49, b: 65 },
  { a: 2088, b: 1 },
  { a: 1047, b: 1 },
  { a: 27, b: 35 },
  { a: 40, b: 18 },
  { a: 200, b: 16 },
  { a: 518, b: 1 },
  { a: 1, b: 63 },
  { a: 65, b: 1 },
  { a: 26, b: 30 },
  { a: 32, b: 87 },
  { a: 31, b: 105 },
  { a: 97, b: 10 },
  { a: 9, b: 241 },
  { a: 194, b: 5 },
  { a: 1418, b: 1 },
  { a: 75, b: 39 },
  { a: 694, b: 3 },
  { a: 4, b: 1 },
  { a: 207, b: 5 },
  { a: 17, b: 218 },
  { a: 70, b: 30 },
  { a: 1, b: 248 },
  { a: 54, b: 34 },
  { a: 34, b: 51 },
  { a: 881, b: 3 },
  { a: 505, b: 5 },
  { a: 2552, b: 1 },
  { a: 634, b: 1 },
  { a: 16, b: 63 },
  { a: 46, b: 2 },
  { a: 64, b: 18 },
  { a: 2810, b: 1 },
  { a: 60, b: 16 },
  { a: 1047, b: 2 },
  { a: 213, b: 8 },
  { a: 19, b: 128 },
  { a: 89, b: 27 },
  { a: 320, b: 10 },
  { a: 92, b: 15 },
  { a: 16, b: 14 },
  { a: 5, b: 42 },
  { a: 25, b: 8 },
  { a: 742, b: 4 },
  { a: 24, b: 25 },
  { a: 58, b: 37 },
  { a: 375, b: 5 },
  { a: 227, b: 9 },
  { a: 1057, b: 1 },
  { a: 32, b: 60 },
  { a: 5, b: 193 },
  { a: 14, b: 49 },
  { a: 56, b: 25 },
  { a: 1590, b: 1 },
  { a: 170, b: 6 },
  { a: 115, b: 35 },
  { a: 1152, b: 1 },
  { a: 11, b: 97 },
  { a: 250, b: 14 },
  { a: 23, b: 172 },
  { a: 103, b: 10 },
  { a: 147, b: 15 },
  { a: 170, b: 24 },
  { a: 16, b: 10 },
  { a: 13, b: 178 },
  { a: 305, b: 7 },
  { a: 8, b: 4 },
  { a: 15, b: 123 },
  { a: 406, b: 8 },
  { a: 4, b: 197 },
  { a: 473, b: 2 },
  { a: 566, b: 5 },
  { a: 152, b: 12 },
  { a: 13, b: 62 },
  { a: 983, b: 2 },
  { a: 14, b: 38 },
  { a: 26, b: 62 },
  { a: 338, b: 9 },
  { a: 10, b: 15 },
  { a: 20, b: 122 },
  { a: 8, b: 67 },
  { a: 37, b: 72 },
  { a: 274, b: 12 },
  { a: 24, b: 76 },
  { a: 4, b: 232 },
  { a: 1589, b: 1 },
  { a: 197, b: 20 },
  { a: 1063, b: 3 },
  { a: 242, b: 10 },
  { a: 48, b: 29 },
  { a: 542, b: 7 },
  { a: 15, b: 46 },
  { a: 275, b: 14 },
  { a: 2497, b: 1 },
  { a: 14, b: 236 },
  { a: 19, b: 158 },
  { a: 47, b: 75 },
  { a: 390, b: 3 },
  { a: 637, b: 3 },
  { a: 96, b: 7 },
  { a: 1249, b: 2 },
  { a: 19, b: 140 },
  { a: 44, b: 58 },
  { a: 747, b: 2 },
  { a: 3, b: 144 },
  { a: 370, b: 2 },
  { a: 35, b: 31 },
  { a: 53, b: 6 },
  { a: 74, b: 23 },
  { a: 818, b: 1 },
  { a: 97, b: 22 },
  { a: 11, b: 114 },
  { a: 448, b: 5 },
  { a: 818, b: 4 },
  { a: 598, b: 6 },
  { a: 130, b: 29 },
  { a: 25, b: 79 },
  { a: 67, b: 54 },
  { a: 93, b: 12 },
  { a: 24, b: 72 },
  { a: 509, b: 7 },
  { a: 1, b: 143 },
  { a: 625, b: 2 },
  { a: 725, b: 3 },
  { a: 250, b: 16 },
  { a: 58, b: 42 },
  { a: 12, b: 50 },
  { a: 24, b: 74 },
  { a: 624, b: 2 },
  { a: 31, b: 52 },
  { a: 882, b: 1 },
  { a: 138, b: 18 },
  { a: 33, b: 16 },
  { a: 60, b: 26 },
  { a: 17, b: 64 },
  { a: 27, b: 84 },
  { a: 32, b: 23 },
  { a: 150, b: 11 },
  { a: 47, b: 11 },
  { a: 6, b: 159 },
  { a: 39, b: 40 },
  { a: 1143, b: 2 },
  { a: 25, b: 106 },
  { a: 8, b: 181 },
  { a: 4, b: 192 },
  { a: 7, b: 28 },
  { a: 2, b: 125 },
  { a: 49, b: 69 },
  { a: 1, b: 67 },
  { a: 157, b: 25 },
  { a: 160, b: 13 },
  { a: 36, b: 33 },
  { a: 53, b: 65 },
  { a: 2364, b: 1 },
  { a: 64, b: 53 },
  { a: 61, b: 56 },
  { a: 1112, b: 1 },
  { a: 198, b: 11 },
  { a: 16, b: 199 },
  { a: 27, b: 102 },
  { a: 405, b: 6 },
  { a: 8, b: 41 },
  { a: 26, b: 79 },
  { a: 2677, b: 1 },
  { a: 20, b: 173 },
  { a: 785, b: 4 },
  { a: 94, b: 29 },
  { a: 256, b: 10 },
  { a: 206, b: 18 },
  { a: 980, b: 1 },
  { a: 107, b: 26 },
  { a: 47, b: 41 },
  { a: 40, b: 98 },
  { a: 444, b: 4 },
  { a: 259, b: 16 },
  { a: 319, b: 11 },
  { a: 1861, b: 1 },
  { a: 111, b: 20 },
  { a: 341, b: 12 },
  { a: 14, b: 240 },
  { a: 82, b: 43 },
  { a: 9, b: 9 },
  { a: 13, b: 212 },
  { a: 196, b: 18 },
  { a: 98, b: 10 },
  { a: 208, b: 7 },
  { a: 400, b: 5 },
  { a: 77, b: 16 },
  { a: 639, b: 3 },
  { a: 17, b: 8 },
  { a: 21, b: 46 },
  { a: 52, b: 81 },
  { a: 221, b: 14 },
  { a: 13, b: 239 },
  { a: 233, b: 11 },
  { a: 15, b: 35 },
  { a: 1122, b: 1 },
  { a: 1178, b: 2 },
  { a: 75, b: 22 },
  { a: 11, b: 138 },
  { a: 22, b: 146 },
  { a: 26, b: 87 },
  { a: 52, b: 43 },
  { a: 776, b: 4 },
  { a: 7, b: 84 },
  { a: 128, b: 13 },
  { a: 57, b: 27 },
  { a: 689, b: 2 },
  { a: 168, b: 7 },
  { a: 1332, b: 1 },
  { a: 37, b: 31 },
  { a: 49, b: 73 },
  { a: 1379, b: 2 },
  { a: 315, b: 6 },
  { a: 276, b: 9 },
  { a: 74, b: 43 },
  { a: 656, b: 1 },
  { a: 905, b: 2 },
  { a: 1649, b: 2 },
  { a: 185, b: 7 },
  { a: 38, b: 93 },
  { a: 8, b: 170 },
  { a: 32, b: 103 },
  { a: 391, b: 4 },
  { a: 181, b: 22 },
  { a: 127, b: 10 },
  { a: 404, b: 1 },
  { a: 268, b: 4 },
  { a: 15, b: 70 },
  { a: 1, b: 193 },
  { a: 2, b: 173 },
  { a: 32, b: 63 },
  { a: 769, b: 1 },
  { a: 9, b: 177 },
  { a: 35, b: 106 },
  { a: 1620, b: 1 },
  { a: 681, b: 3 },
  { a: 998, b: 1 },
  { a: 27, b: 53 },
  { a: 87, b: 29 },
  { a: 3, b: 200 },
  { a: 188, b: 14 },
  { a: 1086, b: 3 },
  { a: 63, b: 34 },
  { a: 59, b: 13 },
  { a: 2042, b: 1 },
  { a: 796, b: 1 },
  { a: 125, b: 26 },
  { a: 43, b: 88 },
  { a: 6, b: 238 },
  { a: 31, b: 2 },
  { a: 506, b: 1 },
  { a: 180, b: 4 },
  { a: 58, b: 23 },
  { a: 24, b: 40 },
  { a: 146, b: 10 },
  { a: 28, b: 30 },
  { a: 79, b: 9 },
  { a: 1501, b: 1 },
  { a: 123, b: 7 },
  { a: 409, b: 5 },
  { a: 13, b: 140 },
  { a: 112, b: 30 },
  { a: 103, b: 34 },
  { a: 586, b: 6 },
  { a: 19, b: 101 },
  { a: 19, b: 88 },
  { a: 859, b: 4 },
  { a: 10, b: 196 },
  { a: 15, b: 74 },
  { a: 84, b: 31 },
  { a: 177, b: 8 },
  { a: 75, b: 15 },
  { a: 28, b: 10 },
  { a: 51, b: 24 },
  { a: 2, b: 147 },
  { a: 174, b: 3 },
  { a: 2279, b: 1 },
  { a: 867, b: 1 },
  { a: 1237, b: 1 },
  { a: 28, b: 77 },
  { a: 391, b: 5 },
  { a: 2141, b: 1 },
  { a: 466, b: 4 },
  { a: 23, b: 153 },
  { a: 6, b: 48 },
  { a: 5, b: 173 },
  { a: 13, b: 216 },
  { a: 235, b: 14 },
  { a: 64, b: 52 },
  { a: 727, b: 4 },
  { a: 1597, b: 2 },
  { a: 285, b: 1 },
  { a: 38, b: 18 },
  { a: 1021, b: 2 },
  { a: 56, b: 60 },
  { a: 41, b: 29 },
  { a: 2403, b: 1 },
  { a: 22, b: 27 },
  { a: 1, b: 213 },
  { a: 977, b: 3 },
  { a: 341, b: 9 },
  { a: 76, b: 46 },
  { a: 14, b: 99 },
  { a: 592, b: 5 },
  { a: 11, b: 140 },
  { a: 42, b: 52 },
  { a: 706, b: 4 },
  { a: 152, b: 18 },
  { a: 88, b: 30 },
  { a: 503, b: 4 },
  { a: 115, b: 32 },
  { a: 282, b: 8 },
  { a: 58, b: 33 },
  { a: 154, b: 8 },
  { a: 130, b: 9 },
  { a: 53, b: 26 },
  { a: 37, b: 3 },
  { a: 1077, b: 2 },
  { a: 218, b: 19 },
  { a: 24, b: 54 },
  { a: 32, b: 102 },
  { a: 811, b: 1 },
  { a: 76, b: 16 },
  { a: 62, b: 21 },
  { a: 25, b: 14 },
  { a: 391, b: 3 },
  { a: 271, b: 11 },
  { a: 854, b: 3 },
  { a: 14, b: 139 },
  { a: 49, b: 44 },
  { a: 10, b: 23 },
  { a: 37, b: 87 },
  { a: 60, b: 6 },
  { a: 301, b: 11 },
  { a: 141, b: 14 },
  { a: 31, b: 122 },
  { a: 362, b: 9 },
  { a: 1711, b: 2 },
  { a: 332, b: 6 },
  { a: 45, b: 23 },
  { a: 135, b: 20 },
  { a: 153, b: 19 },
  { a: 25, b: 103 },
  { a: 98, b: 13 },
  { a: 536, b: 6 },
  { a: 19, b: 98 },
  { a: 10, b: 12 },
  { a: 29, b: 31 },
  { a: 111, b: 21 },
  { a: 1067, b: 3 },
  { a: 286, b: 5 },
  { a: 35, b: 64 },
  { a: 2, b: 29 },
  { a: 1193, b: 2 },
  { a: 38, b: 97 },
  { a: 200, b: 6 },
  { a: 581, b: 2 },
  { a: 2, b: 107 },
  { a: 62, b: 22 },
  { a: 599, b: 1 },
  { a: 305, b: 1 },
  { a: 2020, b: 1 },
  { a: 249, b: 12 },
  { a: 59, b: 57 },
  { a: 1486, b: 1 },
  { a: 414, b: 3 },
  { a: 501, b: 1 },
  { a: 103, b: 7 },
  { a: 757, b: 1 },
  { a: 19, b: 97 },
  { a: 246, b: 10 },
  { a: 16, b: 42 },
  { a: 1032, b: 4 },
  { a: 45, b: 7 },
  { a: 146, b: 8 },
  { a: 901, b: 3 },
  { a: 153, b: 10 },
  { a: 1269, b: 1 },
  { a: 13, b: 154 },
  { a: 637, b: 4 },
  { a: 2, b: 33 },
  { a: 8, b: 176 },
  { a: 201, b: 4 },
  { a: 1325, b: 2 },
  { a: 1690, b: 1 },
  { a: 10, b: 33 },
  { a: 199, b: 5 },
  { a: 90, b: 6 },
  { a: 335, b: 1 },
  { a: 91, b: 29 },
  { a: 586, b: 1 },
  { a: 257, b: 13 },
  { a: 85, b: 17 },
  { a: 15, b: 127 },
  { a: 268, b: 13 },
  { a: 136, b: 22 },
  { a: 148, b: 12 },
  { a: 620, b: 3 },
  { a: 15, b: 131 },
  { a: 41, b: 42 },
  { a: 368, b: 8 },
  { a: 11, b: 4 },
  { a: 1172, b: 3 },
  { a: 82, b: 15 },
  { a: 107, b: 22 },
  { a: 15, b: 1 },
  { a: 157, b: 24 },
  { a: 169, b: 1 },
  { a: 6, b: 113 },
  { a: 3, b: 81 },
  { a: 166, b: 21 },
  { a: 4, b: 224 },
  { a: 967, b: 1 },
  { a: 499, b: 2 },
  { a: 750, b: 4 },
  { a: 25, b: 1 },
  { a: 457, b: 6 },
  { a: 33, b: 90 },
  { a: 307, b: 3 },
  { a: 1068, b: 1 },
  { a: 170, b: 14 },
  { a: 25, b: 37 },
  { a: 1, b: 206 },
  { a: 16, b: 46 },
  { a: 389, b: 7 },
  { a: 195, b: 4 },
  { a: 564, b: 1 },
  { a: 180, b: 5 },
  { a: 76, b: 53 },
  { a: 19, b: 136 },
  { a: 1054, b: 1 },
  { a: 327, b: 5 },
  { a: 35, b: 82 },
  { a: 123, b: 3 },
  { a: 43, b: 4 },
  { a: 194, b: 1 },
  { a: 29, b: 106 },
  { a: 1711, b: 1 },
  { a: 4, b: 84 },
  { a: 153, b: 11 },
  { a: 1441, b: 2 },
  { a: 272, b: 14 },
  { a: 249, b: 4 },
  { a: 1210, b: 1 },
  { a: 486, b: 5 },
  { a: 27, b: 80 },
  { a: 16, b: 171 },
  { a: 463, b: 8 },
  { a: 815, b: 3 },
  { a: 1, b: 34 },
  { a: 7, b: 142 },
  { a: 66, b: 15 },
  { a: 71, b: 55 },
  { a: 1264, b: 1 },
  { a: 38, b: 58 },
  { a: 1513, b: 1 },
  { a: 25, b: 107 },
  { a: 143, b: 4 },
  { a: 1423, b: 1 },
  { a: 120, b: 7 },
  { a: 299, b: 13 },
  { a: 32, b: 128 },
  { a: 143, b: 24 },
  { a: 14, b: 12 },
  { a: 40, b: 14 },
  { a: 1818, b: 1 },
];

(function main() {
  const variant = process.argv[2];

  if (!['16bit', 'multi'].includes(variant)) {
    console.log(`Unknown code variant "${variant}"!`);
    process.exit(0);
  }

  const { rom } = compileCodeForTest(
    variant === '16bit' ? 'submodules/mul16.i4040' : 'submodules/mulMulti.i4040',
    variant === '16bit' ? 'mul16x8' : 'mulMWxMW',
  );

  const runSingleTest = variant === '16bit' ? runSingleTest16bit : runSingleTestMulti;

  let sum = 0;
  for (const [idx, { a, b }] of TESTS.entries()) {
    const expected = a * b;
    const { result, elapsed } = runSingleTest(rom, { a, b });
    if (result !== expected) {
      console.log(`Test failed, a = ${a}, b = ${b}, result = ${result}`);
      process.exit(1);
    }

    sum += (Number(elapsed) - PROLOGUE_CYCLES_COUNT);

    if (idx % 50 === 0) {
      console.log(`Tested ${idx} / ${TESTS.length} cases...`);
    }
  }

  console.log('All tests are passed!');
  console.log(`Avg execution time: ${sum / TESTS.length} cycles`);
}());
